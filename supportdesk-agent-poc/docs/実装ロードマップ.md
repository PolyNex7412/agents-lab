# 実装ロードマップ（どこから直すか）

調達サポートセンター向けに、**影響が大きく・既存コードの延長でやりやすい**順で並べています。

---

## 推奨：まずここから（Phase 1）

### 1. 過去ログを「類似問い合わせ」検索に含める 【最優先】

**現状**: 検索は FAQ だけ。ログは一覧表示のみで、マッチ順の類似問い合わせにはなっていない。  
**やること**:
- 検索対象に **logs.json の question（過去の問い合わせ文）** を加える
- 同じスコアリング（tokenize + overlapScore など）で FAQ とログを一緒にランク付け
- 返すときに **参照元** を区別する（`source: "faq"` | `source: "log"`）
- マッチ順で 1 つのリストとして返す

**効果**: オペレーターが「似た過去の問い合わせ」をマッチ順で見られるようになり、要件 R1〜R3 の土台ができる。

**実装の置き場**:
- **MCP**: 新ツール `search_similar`（FAQ + ログをまとめて検索し、マッチ順で返す）
- **API**: `GET /api/similar?q=...&topK=...` を追加（MCP があればそれを使い、なければ server 内で同様の検索をフォールバック）
- **既存**: `ragRetrieve` のロジックを流用し、ログ用のスコア計算を追加

---

### 2. 問い合わせタブの流れを「類似一覧 → 1次回答 → エスカレ」に揃える

**現状**: 問い合わせ → 回答＋Trace＋Citations で、**類似の過去問い合わせ一覧**が前面に出ていない。  
**やること**:
- 同じ入力で **「類似問い合わせ（マッチ順）」** を画面の上または左に表示
- 各候補に **参照元（FAQ / 過去ログ）** を表示
- その下に **1次回答** と **エスカレ判定・理由** をこれまで通り表示

**効果**: 要件のコアフロー（類似 → 1次回答 → エスカレ）が 1 画面で完結する。

**実装の置き場**:
- **API**: `POST /api/ask` のレスポンスに `similarItems` を追加するか、フロントで `GET /api/similar` を別呼び出しして表示
- **UI**: 問い合わせタブに「類似の過去問い合わせ」セクションを追加し、マッチ順リスト＋参照元ラベルを表示

---

### 3. 1次回答の「根拠」をはっきり出す（Citations の強化）

**現状**: Citations は ID・title・score 程度。過去ログを参照した場合は「どのログの質問・回答か」を示したい。  
**やること**:
- 類似検索でログを含める場合、候補に **ログの question・回答要約・日時** を含める
- 1次回答画面で「この回答の根拠」として、参照した FAQ／過去ログを明示

**効果**: 要件 A2（根拠の提示）を満たし、オペレーターが説明しやすくなる。

---

## その次にやるとよいこと（Phase 2）

### 4. 音声入力（STT）

**やること**:
- ブラウザの **Web Speech API** でマイク入力 → テキスト化（手軽）
- または **Azure Speech / Whisper API** などで精度を上げる（録音ファイル対応も可）

**注意**: まずはテキストで「類似一覧 → 1次回答 → エスカレ」の流れを固めてから、音声を「入力のもう一つの手段」として足すと安全。

---

### 5. エスカレ先の案内（E3）

**やること**:
- 意図やエスカレ理由に応じた **エスカレ先**（担当部署・窓口）を表示
- `data/escalation.json` のようなマスタを用意し、`intent` や `reason` で紐付け

---

## 後回しでよいもの（Phase 3）

- 意図・エスカレ先の**マスタ管理画面**（まずは JSON で運用で十分）
- **ロール・権限**（単一オペレーター運用なら後でよい）
- **CTI・電話連携**（要件が固まってから）

---

## まとめ：今日から手を付けやすいところ

| 順番 | やること | 主に触るファイル |
|------|----------|------------------|
| **1** | 過去ログを類似検索に含め、マッチ順で返す API/ツールを追加 | mcp-server.mjs または server.mjs, mcp-client.mjs |
| **2** | 問い合わせタブに「類似問い合わせ（マッチ順＋参照元）」を表示 | server.mjs（レスポンス拡張）, public/index.html |
| **3** | 根拠表示の強化（参照した FAQ／ログを明示） | 同上 ＋ UI 文言・レイアウト |

**まず直すなら「1. 過去ログを類似検索に含める」** からにすると、既存の RAG/検索の延長で実装でき、その後の 2・3 もやりやすくなります。
